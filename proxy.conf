server {
    listen 80;
    error_log /dev/stdout debug;

    # Si alguien va a la raíz, redirígelo a la app de Grafana
    location = / {
        return 302 $scheme://$http_host/monitor/;
    }

    # El endpoint de métricas sigue igual
    location /metrics {
        proxy_pass http://grafana:3000/metrics;
    }

    # Esta regla captura la petición EXACTA de "/monitor"
    # y le dice al navegador que vaya a "/monitor/" (con barra).
    location = /monitor {
        # 301 es una redirección permanente
        return 301 $scheme://$http_host/monitor/;
    }

    # --- BLOQUE MODIFICADO ---
    # Aquí es donde vivirá la UI de Grafana
    location /monitor/ {
        # La barra al final de proxy_pass es MUY importante.
        # Le dice a NGINX que envíe la petición a la raíz de Grafana.
        # Ejemplo: /monitor/dashboards -> http://grafana:3000/dashboards
        proxy_pass http://grafana:3000/;
        
        # --- Cabeceras recomendadas (sin cambios) ---
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    # Redirige /app a /app/ para asegurar que las rutas relativas funcionen.
    # Usamos $http_host para preservar el puerto original en la redirección.
    location = /app {
        return 301 $scheme://$http_host/app/;
    }

    # Pasa todo el tráfico de /app/ al servicio Go en /bosquesdeagua/
    location /app/ {
        proxy_pass http://host.containers.internal:4000/app;
        
        # Reescribe las redirecciones del backend para que apunten a /app/

        # Cabeceras estándar de proxy, usando $http_host para el Host header
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy para los assets estáticos
    location /static/ {
        proxy_pass http://host.containers.internal:4000/;
    }

}
