server {
    listen 80;
    server_name localhost;

    # Redirect root to the Grafana dashboard
    location = / {
        return 301 $scheme://$http_host/monitor/;
    }

    # Redirect /monitor to /monitor/ to ensure relative paths work correctly.
    location = /monitor {
        return 301 $scheme://$http_host/monitor/;
    }

    # Proxy requests for Grafana.
    # The trailing slash on proxy_pass is important. It tells Nginx to
    # map /monitor/ to the root of the Grafana service.
    # e.g., /monitor/dashboards -> http://grafana:3000/dashboards
    location /monitor/ {
        proxy_pass http://grafana:3000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Redirect /app to /app/ to ensure relative paths work correctly.
    location = /app {
        return 301 $scheme://$http_host/app/;
    }

    # Proxy all requests under /app/ to the Go application.
    # The service name is 'app', not 'bda-app'.
    location /app/ {
        proxy_pass http://app:4000/app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
